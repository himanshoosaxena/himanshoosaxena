name: Update README with Repos

on:
  schedule:
    - cron: "0 0 * * *"   # run daily at midnight UTC
  workflow_dispatch:        # allow manual run

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write       # allow this job to push to README
    env:
      GH_TOKEN: ${{ secrets.REPO_TOKEN }}   # your fine-grained PAT

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build repo list (with descriptions)
        run: |
          # gh automatically uses GH_TOKEN for auth
          gh repo list himanshoosaxena \
            --limit 100 \
            --json name,description,url,isPrivate,isFork,archived \
            --jq '.[] | "- [" + .name + "](" + .url + ") â€” " + ( .description // "No description provided")' \
            > repos.md

      - name: Inject repo list into README
        run: |
          awk 'BEGIN{in_block=0}
               /<!--START_SECTION:my_repos-->/ {
                 print;
                 system("cat repos.md");
                 in_block=1;
                 next
               }
               /<!--END_SECTION:my_repos-->/ {
                 print;
                 in_block=0;
                 next
               }
               in_block==0 { print }' README.md > README.tmp
          mv README.tmp README.md

      - name: Commit & push changes (if any)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if ! git diff --quiet; then
            git add README.md
            git commit -m "Update repo list"
            git push
          fi
