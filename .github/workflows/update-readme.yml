name: Update README with Repos

on:
  schedule:
    - cron: "0 0 * * *"   # run daily at midnight UTC
  workflow_dispatch:        # allow manual run

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write       # allow this job to push to README
    env:
      GH_TOKEN: ${{ secrets.REPO_TOKEN }}   # use your PAT so we see private repos too

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build repo list (with descriptions)
        id: repos
        run: |
          echo "REPO_MARKDOWN<<EOF" >> $GITHUB_OUTPUT
          gh repo list himanshoosaxena \
            --limit 100 \
            --json name,description,url,isPrivate,isFork,archived \
            --jq '.[] | "- [\(.name)](\(.url)) â€” \(.description // "No description provided")"' \
            >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Inject repo list into README
        run: |
          LIST="${{ steps.repos.outputs.REPO_MARKDOWN }}"
          awk 'BEGIN{p=1}
               /<!--START_SECTION:my_repos-->/ {
                 print;
                 print "";
                 print "'"$LIST"'";
                 p=0;
                 next
               }
               /<!--END_SECTION:my_repos-->/ {
                 print;
                 p=1;
                 next
               }
               p { print }' README.md > README.tmp
          mv README.tmp README.md

      - name: Commit & push changes (if any)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if ! git diff --quiet; then
            git add README.md
            git commit -m "Update repo list"
            git push
          fi
