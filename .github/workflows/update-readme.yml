name: Update README with Repos

on:
  schedule:
    - cron: "0 0 * * *"   # run daily at midnight UTC
  workflow_dispatch:        # allow manual run

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write       # allow this job to push to README

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get repo list (public + private)
        id: repos
        uses: yi-Xu-0100/repo-list-generator@v1.1.1
        with:
          user: himanshoosaxena
          my_token: ${{ secrets.REPO_TOKEN }}

      - name: Inject repo list into README
        run: |
          LIST="${{ steps.repos.outputs.repoList_ALL }}"
          awk 'BEGIN{p=1}
               /<!--START_SECTION:my_repos-->/ {
                 print;
                 print "";
                 print "'"$LIST"'";
                 p=0;
                 next
               }
               /<!--END_SECTION:my_repos-->/ {
                 print;
                 p=1;
                 next
               }
               p { print }' README.md > README.tmp
          mv README.tmp README.md

      - name: Commit & push changes (if any)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if ! git diff --quiet; then
            git add README.md
            git commit -m "Update repo list"
            git push
          fi
