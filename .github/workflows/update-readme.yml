name: Update README with Repos

on:
  schedule:
    - cron: "0 0 * * *"   # run daily at midnight UTC
  workflow_dispatch:        # allow manual run

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write       # allow this job to push to README
    env:
      REPO_TOKEN: ${{ secrets.REPO_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build repo list (with descriptions) via GitHub API
        run: |
          # Get all repositories you own (public + private)
          curl -s \
            -H "Authorization: Bearer $REPO_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/user/repos?per_page=100&affiliation=owner" \
            > repos.json

          # Generate markdown: - [name](url) - description
          jq -r '. | sort_by(.name)[] |
            "- [" + .name + "](" + .html_url + ") - " +
            ( .description // "No description provided" )' \
            repos.json > repos.md

      - name: Inject repo list into README
        run: |
          awk 'BEGIN{in_block=0}
               /<!--START_SECTION:my_repos-->/ {
                 print;
                 system("cat repos.md");
                 in_block=1;
                 next
               }
               /<!--END_SECTION:my_repos-->/ {
                 print;
                 in_block=0;
                 next
               }
               in_block==0 { print }' README.md > README.tmp
          mv README.tmp README.md

      - name: Commit & push changes (if any)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if ! git diff --quiet; then
            git add README.md
            git commit -m "Update repo list"
            git push
          fi
